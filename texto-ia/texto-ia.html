<!DOCTYPE html>
<html lang="pt-br" class="h-full antialiased">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kyro V5.4 - Suite Profissional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            serif: ['Playfair Display', 'serif'],
          },
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              900: '#0c4a6e',
            }
          },
          animation: {
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.2s ease-out',
          },
          keyframes: {
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Scrollbar Minimalista */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #334155; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Utilit√°rios de Impress√£o */
    @media print {
      body * { visibility: hidden; }
      #printable-area, #printable-area * { visibility: visible; }
      #printable-area { 
        position: absolute; left: 0; top: 0; width: 100%; 
        background: white; padding: 2cm; color: black; 
      }
      .no-print { display: none !important; }
    }

    /* Efeitos de foco sutis */
    .btn-action { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-action:active { transform: scale(0.98); }
    
    /* Input Switch */
    .toggle-checkbox:checked { right: 0; border-color: #0ea5e9; }
    .toggle-checkbox:checked + .toggle-label { background-color: #0ea5e9; }
  </style>
</head>

<body class="flex flex-col h-screen overflow-hidden bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300 font-sans selection:bg-brand-100 selection:text-brand-900 dark:selection:bg-brand-900 dark:selection:text-brand-100">

  <!-- TOAST CONTAINER -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

  <!-- HEADER -->
  <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 flex-shrink-0 z-30 transition-colors no-print">
    <div class="max-w-[1600px] mx-auto px-4 h-full flex items-center justify-between">
      
      <!-- Logo -->
      <div class="flex items-center gap-3 select-none">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-800 to-slate-900 text-white flex items-center justify-center font-serif font-bold text-lg shadow-lg shadow-slate-200 dark:shadow-none">K</div>
        <div>
          <h1 class="text-sm font-semibold tracking-wide text-slate-900 dark:text-white">Kyro Suite</h1>
          <p class="text-[10px] text-slate-500 uppercase tracking-widest font-medium">Jur√≠dico Inteligente</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex items-center gap-2 md:gap-4">
        
        <!-- Toggle Switch -->
        <div class="flex items-center gap-3 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
            <div class="relative inline-block w-8 align-middle select-none">
                <input type="checkbox" id="ai-mode-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 border-slate-300 appearance-none cursor-pointer left-0 transition-all duration-300" onclick="handleToggleClick()">
                <label for="ai-mode-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
            </div>
            <span class="text-xs font-semibold text-slate-500 dark:text-slate-400 min-w-[60px] text-center" id="mode-label">Offline</span>
        </div>

        <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>

        <!-- Toolbar Icons -->
        <button onclick="toggleHistory()" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors" title="Hist√≥rico">
            <i class="fa-solid fa-clock-rotate-left"></i>
        </button>
        <button onclick="toggleConfigModal()" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors relative" title="Configura√ß√µes">
            <i class="fa-solid fa-sliders"></i>
            <span id="config-badge" class="hidden absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-red-500 rounded-full border border-white dark:border-slate-800"></span>
        </button>
        <button onclick="toggleTheme()" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-amber-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
            <i class="fa-solid fa-moon dark:hidden"></i>
            <i class="fa-solid fa-sun hidden dark:inline"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="flex-1 flex overflow-hidden relative max-w-[1600px] mx-auto w-full">
    
    <!-- SIDEBAR HIST√ìRICO (Slide Over) -->
    <aside id="history-sidebar" class="absolute top-0 right-0 h-full w-80 bg-white/95 dark:bg-slate-800/95 backdrop-blur-xl shadow-2xl border-l border-slate-200 dark:border-slate-700 z-40 transform translate-x-full transition-transform duration-300 flex flex-col no-print">
        <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
            <h3 class="font-serif font-bold text-slate-800 dark:text-white text-lg">Hist√≥rico</h3>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            <div class="text-center text-slate-400 text-sm mt-10">Nenhum registro recente.</div>
        </div>
        <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
            <button onclick="clearHistory()" class="w-full py-2.5 text-xs font-semibold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition border border-transparent hover:border-red-100">Limpar Hist√≥rico</button>
        </div>
    </aside>

    <!-- MODAL CONFIGURA√á√ÉO -->
    <div id="config-modal" class="hidden absolute top-20 right-4 w-96 bg-white dark:bg-slate-800 shadow-2xl rounded-2xl border border-slate-200 dark:border-slate-700 z-50 p-6 animate-slide-up no-print">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h3 class="font-serif font-bold text-lg text-slate-800 dark:text-white">Configura√ß√£o API</h3>
            <p class="text-xs text-slate-500">Google Gemini 2.5 Integration</p>
          </div>
          <button onclick="toggleConfigModal()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-slate-800 dark:hover:text-white flex items-center justify-center transition-colors"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2 uppercase tracking-wide">Chave de Acesso</label>
                <input type="password" id="api-key-input" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all font-mono text-slate-600 dark:text-slate-300 placeholder-slate-400" placeholder="AIzaSy...">
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="testApiKey()" class="flex-1 px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 text-xs font-semibold transition-colors">
                    Testar Conex√£o
                </button>
                <button onclick="saveApiKey()" class="flex-1 px-4 py-2 rounded-lg bg-slate-900 dark:bg-brand-600 hover:bg-slate-800 dark:hover:bg-brand-500 text-white text-xs font-semibold shadow-lg shadow-slate-200 dark:shadow-none transition-colors">
                    Salvar Chave
                </button>
            </div>
            
            <div id="test-result" class="hidden p-3 rounded-lg text-xs bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-700"></div>
            
            <div class="pt-4 border-t border-slate-100 dark:border-slate-700 text-center">
                <button onclick="clearApiKey()" class="text-xs text-red-400 hover:text-red-600 hover:underline transition-colors">Remover credenciais salvas</button>
            </div>
        </div>
    </div>

    <!-- WORKSPACE -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-0 lg:gap-px bg-slate-200 dark:bg-slate-700 h-full">
      
      <!-- ESQUERDA: EDITOR -->
      <section class="bg-white dark:bg-slate-900 flex flex-col h-full overflow-hidden relative group no-print">
        
        <!-- Toolbar Superior -->
        <div class="px-6 py-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
            <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                <i class="fa-solid fa-feather-pointed text-slate-400"></i> Entrada
            </h2>
            <div class="flex gap-2">
                <button onclick="toggleDictation()" class="p-2 text-slate-400 hover:text-brand-600 transition-colors" title="Ditado">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <div class="relative group/tooltip">
                    <select onchange="insertTemplate(this.value); this.value=''" class="appearance-none bg-slate-50 dark:bg-slate-800 border-none text-xs font-medium text-slate-600 dark:text-slate-300 py-1.5 pl-3 pr-8 rounded-md cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:ring-0">
                        <option value="">Inserir Modelo...</option>
                        <option value="deferimento">Deferimento Padr√£o</option>
                        <option value="citacao">Cita√ß√£o Edital</option>
                        <option value="prescricao">Prescri√ß√£o CTN</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                        <i class="fa-solid fa-chevron-down text-[10px]"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Textarea -->
        <div class="flex-1 relative">
            <textarea id="input-text" spellcheck="true"
            class="w-full h-full p-6 resize-none focus:outline-none bg-transparent font-mono text-base text-slate-700 dark:text-slate-300 placeholder-slate-300 dark:placeholder-slate-700 leading-relaxed custom-scrollbar"
            placeholder="Comece a digitar ou cole seu texto jur√≠dico aqui..." oninput="updateCounters('input')"></textarea>
            
            <!-- Contador -->
            <div class="absolute bottom-4 right-6 text-[10px] font-medium text-slate-300 dark:text-slate-600 bg-white dark:bg-slate-900 px-2 py-1 rounded-md border border-slate-100 dark:border-slate-800 shadow-sm pointer-events-none">
               <span id="input-counter">0 palavras</span>
            </div>
        </div>

        <!-- Action Bar (Floating Grid) -->
        <div class="p-4 bg-slate-50/80 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800 backdrop-blur-sm">
            <div class="grid grid-cols-6 gap-2">
                
                <!-- Ferramenta: Corre√ß√£o -->
                <button onclick="routeProcess('correcao')" class="btn-action flex flex-col items-center justify-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-brand-300 dark:hover:border-brand-700 hover:shadow-md transition-all group">
                    <i class="fa-solid fa-wand-magic-sparkles text-slate-400 group-hover:text-brand-500 mb-2 text-lg"></i>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-white uppercase">Corrigir</span>
                </button>

                <!-- Ferramenta: Erudito -->
                <button onclick="routeProcess('rebuscado')" class="btn-action flex flex-col items-center justify-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-amber-300 dark:hover:border-amber-700 hover:shadow-md transition-all group">
                    <i class="fa-solid fa-scroll text-slate-400 group-hover:text-amber-500 mb-2 text-lg"></i>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-white uppercase">Formalizar</span>
                </button>

                <!-- Ferramenta: Simplificar -->
                <button onclick="routeProcess('simplificar')" class="btn-action flex flex-col items-center justify-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-cyan-300 dark:hover:border-cyan-700 hover:shadow-md transition-all group">
                    <i class="fa-solid fa-comments text-slate-400 group-hover:text-cyan-500 mb-2 text-lg"></i>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-white uppercase">Simplificar</span>
                </button>

                <!-- Ferramenta: Despacho (Destaque) -->
                <button onclick="routeProcess('tecnico')" class="btn-action col-span-2 md:col-span-1 flex flex-col items-center justify-center p-3 rounded-xl bg-slate-800 dark:bg-slate-700 border border-slate-900 dark:border-slate-600 hover:bg-slate-700 dark:hover:bg-slate-600 shadow-lg shadow-slate-200 dark:shadow-none transition-all group">
                    <i class="fa-solid fa-gavel text-white/90 mb-2 text-lg"></i>
                    <span class="text-[10px] font-bold text-white uppercase tracking-wide">Despacho</span>
                </button>

                <!-- Ferramenta: Resumir -->
                <button onclick="routeProcess('resumo')" class="btn-action flex flex-col items-center justify-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-purple-300 dark:hover:border-purple-700 hover:shadow-md transition-all group">
                    <i class="fa-solid fa-list-check text-slate-400 group-hover:text-purple-500 mb-2 text-lg"></i>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-white uppercase">Resumir</span>
                </button>

                <!-- Ferramenta: Extrair -->
                <button onclick="routeProcess('extracao')" class="btn-action flex flex-col items-center justify-center p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-pink-300 dark:hover:border-pink-700 hover:shadow-md transition-all group">
                    <i class="fa-solid fa-fingerprint text-slate-400 group-hover:text-pink-500 mb-2 text-lg"></i>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-white uppercase">Dados</span>
                </button>

            </div>
        </div>
      </section>

      <!-- DIREITA: RESULTADO -->
      <section class="bg-slate-50 dark:bg-[#0f172a] flex flex-col h-full overflow-hidden relative">
        
        <!-- Header Resultado -->
        <div class="px-6 py-4 flex justify-between items-center border-b border-slate-200 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm no-print">
            <h2 class="text-sm font-semibold text-brand-600 dark:text-brand-400 uppercase tracking-widest flex items-center gap-2">
                <i class="fa-solid fa-file-signature"></i> Resultado
                <span id="badge-mode" class="text-[9px] bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded-full ml-2 font-medium">Aguardando</span>
            </h2>
            
            <div class="flex gap-2">
                <button onclick="exportToWord()" class="text-xs font-medium flex items-center gap-2 text-brand-700 dark:text-brand-300 bg-brand-50 dark:bg-brand-900/30 px-3 py-1.5 rounded-lg hover:bg-brand-100 dark:hover:bg-brand-900/50 transition-colors">
                    <i class="fa-solid fa-file-word"></i> Word
                </button>
                <button onclick="copyToClipboard()" id="btn-copy" class="text-xs font-medium flex items-center gap-2 text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-3 py-1.5 rounded-lg hover:border-slate-300 dark:hover:border-slate-600 transition-colors">
                    <i class="fa-regular fa-copy"></i> Copiar
                </button>
            </div>
        </div>

        <!-- Conte√∫do -->
        <div class="flex-1 p-8 md:p-12 overflow-y-auto custom-scrollbar relative" id="output-container">
            
            <!-- Impress√£o -->
            <div id="printable-area" class="hidden">
                <div class="border-b-2 border-black mb-8 pb-4 text-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Bras%C3%A3o_de_Limeira.svg/1200px-Bras%C3%A3o_de_Limeira.svg.png" style="height: 60px; display: block; margin: 0 auto 10px auto;" class="grayscale">
                    <h1 class="text-xl font-bold font-serif uppercase tracking-widest">Prefeitura Municipal de Limeira</h1>
                    <h2 class="text-xs font-sans uppercase tracking-widest mt-1">Secretaria de Assuntos Jur√≠dicos</h2>
                </div>
                <div id="print-content" class="text-justify font-serif text-lg leading-loose"></div>
            </div>

            <!-- Estado Vazio -->
            <div id="placeholder-state" class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 no-print select-none">
                <div class="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner">
                    <i class="fa-solid fa-scale-balanced text-4xl text-slate-300 dark:text-slate-600"></i>
                </div>
                <h3 class="text-lg font-serif font-medium text-slate-600 dark:text-slate-400 mb-2">√Årea de Processamento</h3>
                <p class="text-sm text-slate-400 max-w-xs text-center">Selecione uma ferramenta na barra inferior esquerda para transformar seu texto.</p>
            </div>

            <!-- Loading -->
            <div id="loader-state" class="hidden h-full flex flex-col items-center justify-center no-print">
                <div class="relative w-16 h-16 mb-4">
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-slate-100 dark:border-slate-800 rounded-full"></div>
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400 animate-pulse" id="loader-msg">Processando...</p>
            </div>

            <!-- Resultado Edit√°vel -->
            <div id="content-state" class="hidden h-full flex flex-col no-print animate-fade-in">
                <div id="output-text" class="prose prose-slate dark:prose-invert max-w-none text-slate-800 dark:text-slate-200 leading-8 text-justify whitespace-pre-wrap font-serif text-lg outline-none focus:ring-0" contenteditable="true"></div>
            </div>

        </div>
      </section>

    </div>
  </main>

  <script>
    // --- ESTADO DO SISTEMA ---
    let userApiKey = ""; 
    let useAI = false; 
    let history = JSON.parse(localStorage.getItem('kyro_history') || '[]');

    // --- NOTIFICA√á√ïES TOAST (Design Refinado) ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        container.style.pointerEvents = 'none';
        
        const types = {
            success: { icon: 'fa-check', bg: 'bg-emerald-500', border: 'border-emerald-400' },
            error:   { icon: 'fa-xmark', bg: 'bg-rose-500', border: 'border-rose-400' },
            warning: { icon: 'fa-exclamation', bg: 'bg-amber-500', border: 'border-amber-400' },
            info:    { icon: 'fa-info', bg: 'bg-slate-800', border: 'border-slate-700' }
        };
        const style = types[type] || types.info;

        toast.className = `transform transition-all duration-300 ease-out translate-x-10 opacity-0 pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-xl backdrop-blur-md ${style.bg} text-white border ${style.border} min-w-[280px] max-w-sm`;
        toast.innerHTML = `
            <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
                <i class="fa-solid ${style.icon} text-xs"></i>
            </div>
            <span class="text-xs font-medium tracking-wide">${message}</span>
        `;
        
        container.appendChild(toast);
        
        // Anima√ß√£o de entrada
        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-10', 'opacity-0');
        });

        setTimeout(() => {
            toast.classList.add('translate-x-10', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3500);
    }

    // --- TOGGLE IA / OFFLINE ---
    function handleToggleClick() {
        const checkbox = document.getElementById('ai-mode-toggle');
        const label = document.getElementById('mode-label');

        if (checkbox.checked) {
            const sharedKey = localStorage.getItem('kyro_gemini_api_key');
            if (!sharedKey || sharedKey.length < 5) {
                checkbox.checked = false; 
                document.getElementById('config-badge').classList.remove('hidden');
                showToast("Configure a Chave API primeiro.", "warning");
                toggleConfigModal(); 
                return;
            }
            userApiKey = sharedKey;
            useAI = true;
            label.textContent = "IA Online";
            label.className = "text-xs font-bold text-brand-600 dark:text-brand-400 min-w-[60px] text-center";
            showToast("Gemini 2.5 Ativado", "success");
        } else {
            useAI = false;
            label.textContent = "Offline";
            label.className = "text-xs font-bold text-slate-500 dark:text-slate-400 min-w-[60px] text-center";
            showToast("Modo Local Ativado", "info");
        }
    }

    // --- L√ìGICA DE PROCESSAMENTO ---
    function routeProcess(type) {
        const text = document.getElementById("input-text").value.trim();
        if (!text) { 
            showToast("A caixa de texto est√° vazia.", "warning"); 
            document.getElementById("input-text").focus();
            return; 
        }

        if (useAI) {
            if(!userApiKey) {
                userApiKey = localStorage.getItem('kyro_gemini_api_key');
                if(!userApiKey) {
                    showToast("Chave API n√£o encontrada.", "error");
                    document.getElementById('ai-mode-toggle').checked = false;
                    handleToggleClick(); 
                    processOffline(type, text);
                    return;
                }
            }
            processWithAI(type, text);
        } else {
            processOffline(type, text);
        }
    }

    // --- MODO OFFLINE (L√≥gica Simples) ---
    function processOffline(type, text) {
        setOutputState('loading', 'Processando localmente...');
        updateBadge('Modo Offline');

        setTimeout(() => { 
            let result = "";
            const today = new Date().toLocaleDateString('pt-BR');

            switch(type) {
                case 'simplificar':
                    result = text.replace(/outrossim/gi, "al√©m disso")
                                 .replace(/destarte/gi, "dessa forma")
                                 .replace(/data v√™nia/gi, "com todo respeito")
                                 .replace(/adimplir/gi, "pagar");
                    result += "\n\n(Nota: A simplifica√ß√£o Offline √© baseada em dicion√°rio simples.)";
                    break;
                case 'extracao':
                    const monies = text.match(/R\$\s?[\d.,]+/gi) || [];
                    const dates = text.match(/\d{2}\/\d{2}\/\d{4}/g) || [];
                    const processes = text.match(/\d{4}\.\d{3}\.\d{6}-\d/g) || ["N√£o detectado"];
                    result = `üìå DADOS EXTRA√çDOS (OFFLINE):\n\nüí∞ Valores: ${monies.join(', ') || '-'}\nüìÖ Datas: ${dates.join(', ') || '-'}\n‚öñÔ∏è Processos: ${processes.join(', ')}`;
                    break;
                case 'tecnico':
                    result = `DESPACHO ADMINISTRATIVO\n\nRefer√™ncia: An√°lise preliminar\nData: ${today}\n\n1. Trata-se de an√°lise referente ao texto apresentado.\n2. CONSIDERANDO o teor: "${text.substring(0, 100)}..."\n3. Encaminhe-se ao setor competente para as provid√™ncias cab√≠veis.\n\nAtenciosamente,\n\nJur√≠dico Limeira.`;
                    break;
                case 'rebuscado':
                    const dict = { "pedido": "pleito", "pedir": "requerer", "diz": "aduz", "fala": "relata", "dinheiro": "pec√∫nia", "pagar": "adimplir", "n√£o": "negativo", "sim": "positivo" };
                    result = text;
                    for (const [key, value] of Object.entries(dict)) {
                        const regex = new RegExp(`\\b${key}\\b`, 'gi');
                        result = result.replace(regex, value.toUpperCase());
                    }
                    break;
                case 'resumo':
                    result = `S√çNTESE DOS FATOS:\n\n${text.split(/[.!?]/).slice(0, 2).join('. ') + '.'}`;
                    break;
                case 'correcao':
                    result = text;
                    showToast("No modo Offline, use o corretor do navegador.", "info");
                    break;
            }
            
            if(result) {
                renderOutput(result);
                addToHistory(type + ' (Local)', text, result);
            }
        }, 600); // Delay artificial para UX
    }

    // --- MODO IA (Integra√ß√£o Gemini) ---
    async function processWithAI(type, text) {
        setOutputState('loading', 'Gemini 2.5 trabalhando...');
        updateBadge('IA Gemini 2.5');

        const baseContext = "Voc√™ √© um Assistente Jur√≠dico S√™nior da Prefeitura de Limeira. Responda apenas com o texto solicitado, sem introdu√ß√µes como 'Aqui est√° o texto'.";
        let prompt = "";

        switch (type) {
            case 'correcao': prompt = `${baseContext} Realize uma revis√£o gramatical e ortogr√°fica rigorosa, mantendo o tom jur√≠dico formal: "${text}"`; break;
            case 'rebuscado': prompt = `${baseContext} Eleve o n√≠vel do texto para um padr√£o jur√≠dico erudito, culto e formal: "${text}"`; break;
            case 'simplificar': prompt = `${baseContext} Aplique t√©cnicas de Legal Design e Linguagem Simples (Plain Language). Traduza o texto para que um cidad√£o leigo entenda perfeitamente, sem juridiqu√™s: "${text}"`; break;
            case 'tecnico': prompt = `${baseContext} Elabore um despacho jur√≠dico t√©cnico completo, com fundamenta√ß√£o te√≥rica impl√≠cita, tom de autoridade e estrutura formal, baseando-se nestes fatos: "${text}"`; break;
            case 'resumo': prompt = `${baseContext} Crie um resumo executivo em t√≥picos (bullet points) destacando os fatos principais e requerimentos: "${text}"`; break;
            case 'extracao': prompt = `${baseContext} Extraia e liste: Datas, Valores Monet√°rios (R$), Nomes de Envolvidos e N√∫meros de Processos/Leis. Formate como uma ficha t√©cnica: "${text}"`; break;
        }

        try {
            const apiKey = userApiKey || localStorage.getItem('kyro_gemini_api_key');
            // Usando endpoint padr√£o de gera√ß√£o
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.3 }
                })
            });

            if (!response.ok) throw new Error("Falha na API");
            
            const data = await response.json();
            const resultText = data.candidates[0].content.parts[0].text;

            renderOutput(resultText);
            addToHistory(type, text, resultText);
            showToast("Processamento conclu√≠do", "success");

        } catch (error) {
            console.error(error);
            showToast("Erro na conex√£o com IA.", "error");
            document.getElementById('ai-mode-toggle').click(); // Volta para offline
        }
    }

    // --- FUN√á√ïES DE ARQUIVO E API ---
    async function testApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        const resultDiv = document.getElementById('test-result');
        
        if(key.length < 10) { showToast("Chave inv√°lida.", "warning"); return; }

        resultDiv.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verificando...';
        resultDiv.classList.remove('hidden', 'text-green-600', 'text-red-600');
        resultDiv.classList.add('text-slate-500');

        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: "Teste" }] }] })
            });

            if (response.ok) {
                resultDiv.innerHTML = '<i class="fa-solid fa-check-circle"></i> Chave V√°lida e Operacional';
                resultDiv.classList.replace('text-slate-500', 'text-green-600');
            } else { throw new Error(); }
        } catch (e) {
            resultDiv.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Chave Inv√°lida ou Erro de Rede';
            resultDiv.classList.replace('text-slate-500', 'text-red-600');
        }
    }

    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if(key.length > 10) {
            localStorage.setItem('kyro_gemini_api_key', key);
            userApiKey = key;
            toggleConfigModal();
            showToast("Chave API salva com sucesso", "success");
            
            // Auto-ativar
            const checkbox = document.getElementById('ai-mode-toggle');
            if(!checkbox.checked) checkbox.click();
            document.getElementById('config-badge').classList.add('hidden');
        }
    }

    function clearApiKey() {
        if(confirm("Deseja remover a chave API deste navegador?")) {
            localStorage.removeItem('kyro_gemini_api_key');
            userApiKey = "";
            document.getElementById('api-key-input').value = "";
            document.getElementById('test-result').classList.add('hidden');
            const checkbox = document.getElementById('ai-mode-toggle');
            if(checkbox.checked) checkbox.click();
            toggleConfigModal();
            showToast("Credenciais removidas", "info");
        }
    }

    // --- UI HELPERS ---
    function renderOutput(text) {
        document.getElementById('output-text').innerText = text;
        // Prepara para impress√£o (preserva quebras de linha)
        document.getElementById('print-content').innerHTML = text.replace(/\n/g, '<br>');
        setOutputState('content');
    }

    function setOutputState(state, msg = "") {
        const states = ['placeholder-state', 'loader-state', 'content-state'];
        states.forEach(s => document.getElementById(s).classList.add('hidden'));

        if (state === 'loading') {
            document.getElementById('loader-state').classList.remove('hidden');
            document.getElementById('loader-msg').innerText = msg;
        } else if (state === 'content') {
            document.getElementById('content-state').classList.remove('hidden');
        } else {
            document.getElementById('placeholder-state').classList.remove('hidden');
        }
    }

    function updateBadge(text) {
        document.getElementById('badge-mode').innerText = text;
    }

    function toggleConfigModal() { document.getElementById('config-modal').classList.toggle('hidden'); }
    
    function toggleTheme() { 
        document.documentElement.classList.toggle('dark'); 
        localStorage.setItem('kyro_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    }

    function updateCounters(id) {
        const text = document.getElementById(id + '-text').value;
        const count = text.trim() === '' ? 0 : text.split(/\s+/).filter(w=>w).length;
        document.getElementById(id + '-counter').innerText = `${count} palavras`;
    }

    function insertTemplate(v) { 
        const templates = {
            'deferimento': 'Defiro o pedido de parcelamento do d√©bito em 36 parcelas mensais e sucessivas, com fundamento na Lei Complementar Municipal vigente. Encaminhe-se √† Divis√£o de Rendas para emiss√£o das guias.',
            'citacao': 'Certifico que o r√©u encontra-se em local incerto e n√£o sabido, esgotadas as tentativas de localiza√ß√£o via sistemas conveniados (Bacenjud, Renajud). Requer-se, portanto, a cita√ß√£o via Edital, nos termos do art. 256 do CPC.',
            'prescricao': 'Verifica-se a ocorr√™ncia da prescri√ß√£o do cr√©dito tribut√°rio, haja vista o decurso de prazo superior a 5 anos desde a constitui√ß√£o definitiva sem causa interruptiva, conforme art. 174 do CTN. Opina-se pela extin√ß√£o da execu√ß√£o.'
        };
        if(v && templates[v]) {
            const input = document.getElementById('input-text');
            input.value = input.value ? input.value + "\n\n" + templates[v] : templates[v];
            updateCounters('input');
        }
    }

    function copyToClipboard() {
        const text = document.getElementById('output-text').innerText;
        if(!text) return;
        navigator.clipboard.writeText(text);
        showToast("Copiado para a √°rea de transfer√™ncia", "success");
    }

    function exportToWord() {
        const content = document.getElementById('output-text').innerText;
        if(!content) { showToast("Nada para exportar", "warning"); return; }
        
        const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Documento</title></head><body>";
        const footer = "</body></html>";
        const sourceHTML = header + content.replace(/\n/g, "<br>") + footer;
        
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = 'Documento_Kyro.doc';
        fileDownload.click();
        document.body.removeChild(fileDownload);
        showToast("Download iniciado", "success");
    }

    // --- HIST√ìRICO ---
    function toggleHistory() {
        const sidebar = document.getElementById('history-sidebar');
        sidebar.classList.toggle('translate-x-full');
        if(!sidebar.classList.contains('translate-x-full')) renderHistory();
    }

    function addToHistory(type, input, output) {
        const item = {
            id: Date.now(),
            date: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
            type: type,
            inputSnippet: input.substring(0, 40) + (input.length > 40 ? '...' : ''),
            output: output
        };
        history.unshift(item);
        if (history.length > 15) history.pop();
        localStorage.setItem('kyro_history', JSON.stringify(history));
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        
        if(history.length === 0) {
            list.innerHTML = '<div class="flex flex-col items-center justify-center h-40 text-slate-400"><i class="fa-regular fa-folder-open text-2xl mb-2"></i><span class="text-xs">Sem hist√≥rico</span></div>';
            return;
        }

        history.forEach(item => {
            const el = document.createElement('div');
            el.className = "bg-white dark:bg-slate-700/50 p-3 rounded-xl border border-slate-100 dark:border-slate-600 hover:shadow-md hover:border-brand-200 dark:hover:border-brand-800 transition-all cursor-pointer group";
            el.onclick = () => {
                document.getElementById('output-text').innerText = item.output;
                document.getElementById('print-content').innerHTML = item.output.replace(/\n/g, '<br>');
                setOutputState('content');
                toggleHistory();
                showToast("Hist√≥rico restaurado", "info");
            };
            el.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 px-1.5 py-0.5 rounded">${item.type}</span>
                    <span class="text-[10px] text-slate-400">${item.date}</span>
                </div>
                <div class="text-xs text-slate-600 dark:text-slate-300 font-medium truncate mb-1">"${item.inputSnippet}"</div>
                <div class="text-[10px] text-slate-400 group-hover:text-brand-500 transition-colors text-right">Toque para restaurar <i class="fa-solid fa-arrow-right ml-1"></i></div>
            `;
            list.appendChild(el);
        });
    }

    function clearHistory() {
        history = [];
        localStorage.removeItem('kyro_history');
        renderHistory();
        showToast("Hist√≥rico limpo", "info");
    }

    function toggleDictation() {
        showToast("O navegador pode solicitar permiss√£o de microfone.", "info");
        // Implementa√ß√£o futura de Web Speech API
    }

    // Inicializa√ß√£o
    window.onload = () => {
        const savedKey = localStorage.getItem('kyro_gemini_api_key');
        const checkbox = document.getElementById('ai-mode-toggle');
        const label = document.getElementById('mode-label');
        
        if(savedKey) {
            userApiKey = savedKey;
            document.getElementById('api-key-input').value = savedKey;
            checkbox.checked = true;
            useAI = true;
            label.textContent = "IA Online";
            label.className = "text-xs font-bold text-brand-600 dark:text-brand-400 min-w-[60px] text-center";
        } else {
            document.getElementById('config-badge').classList.remove('hidden');
        }
        
        if (localStorage.getItem('kyro_theme') === 'dark') document.documentElement.classList.add('dark');
    }

  </script>
</body>
</html>