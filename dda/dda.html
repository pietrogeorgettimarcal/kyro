<!DOCTYPE html>
<html lang="pt-br" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kyro Suite v6 - Extra√ß√£o Original & Jur√≠dico IA</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            slate: { 850: '#1e293b' },
            kyro: { 
                light: '#004a91', 
                dark: '#3b82f6' 
            }
          },
          animation: {
            'slide-in': 'slideIn 0.3s ease-out',
            'fade-out': 'fadeOut 0.3s ease-in forwards',
            'fade-in': 'fadeIn 0.5s ease-in-out',
          },
          keyframes: {
            slideIn: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
            fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
            fadeIn: { 'from': { opacity: '0', transform: 'translateY(10px)' }, 'to': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- PDF.js (Essencial para Extra√ß√£o) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3, .serif-font { font-family: 'Playfair Display', serif; }

    /* Scrollbars */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Toggles & Checkboxes */
    .toggle-checkbox:checked { right: 0; border-color: #10b981; }
    .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }

    /* Table Styles ID√äNTICOS AO ORIGINAL (Adaptados para Tailwind + Dark Mode) */
    .kyro-table th { font-size: 0.7rem; white-space: nowrap; padding: 8px 4px; background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; color: #475569; font-weight: 700; text-transform: uppercase; border-right: 1px solid #e2e8f0; }
    .kyro-table td { font-size: 0.7rem; white-space: nowrap; padding: 6px 4px; border-bottom: 1px solid #f1f5f9; color: #334155; border-right: 1px solid #f1f5f9; }
    .kyro-table tr:hover td { background-color: #f0f9ff; }
    
    .dark .kyro-table th { background-color: #1e293b; color: #cbd5e1; border-bottom: 2px solid #334155; border-right: 1px solid #334155; }
    .dark .kyro-table td { color: #e2e8f0; border-bottom: 1px solid #334155; border-right: 1px solid #334155; }
    .dark .kyro-table tr:hover td { background-color: #334155; }
    
    .col-money { text-align: right; font-family: monospace; min-width: 80px; }
    .col-center { text-align: center; }

    .txt-preview {
        font-family: 'Courier New', Courier, monospace;
        font-size: 11px;
        white-space: pre;
        overflow-x: auto;
        background-color: #1e293b;
        color: #4ade80;
        padding: 1rem;
        border-radius: 0.5rem;
        max-height: 200px;
    }

    #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }

    @media print {
      body * { visibility: hidden; }
      #printable-area, #printable-area * { visibility: visible; }
      #printable-area { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 40px; color: black; }
      .no-print { display: none !important; }
    }
  </style>
</head>

<body class="flex flex-col h-screen overflow-hidden text-slate-800 bg-slate-50 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

  <!-- TOAST CONTAINER -->
  <div id="toast-container"></div>

  <!-- HEADER -->
  <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 h-16 flex-shrink-0 z-20 shadow-sm no-print relative">
    <div class="container mx-auto px-4 h-full flex items-center justify-between">
      
      <!-- Brand & Nav -->
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-3">
            <div class="bg-kyro-light dark:bg-kyro-dark text-white w-10 h-10 rounded flex items-center justify-center text-lg font-serif font-bold shadow-sm">K</div>
            <div class="leading-tight">
            <h1 class="text-lg text-slate-900 dark:text-white tracking-tight">Kyro Suite <span class="text-xs bg-indigo-100 text-indigo-800 px-1 rounded ml-1 font-bold">V6</span></h1>
            <p class="text-xs text-slate-500 dark:text-slate-400 font-sans uppercase tracking-wider">Integrated</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="hidden md:flex space-x-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
            <button onclick="switchTab('extraction')" id="tab-extraction" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all shadow bg-white dark:bg-slate-600 text-slate-800 dark:text-white">
                <i class="fas fa-file-invoice mr-2"></i>Extra√ß√£o PDF (Original)
            </button>
            <button onclick="switchTab('editor')" id="tab-editor" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
                <i class="fas fa-gavel mr-2"></i>Editor Jur√≠dico
            </button>
        </nav>
      </div>
      
      <!-- Right Tools -->
      <div class="flex items-center gap-4">
        <!-- AI Toggle -->
        <div class="flex items-center gap-2 mr-4 border-r border-slate-200 dark:border-slate-700 pr-4 hidden sm:flex">
            <span class="text-xs font-medium text-slate-500 dark:text-slate-400">Offline</span>
            <div class="relative inline-block w-10 mr-2 align-middle select-none">
                <input type="checkbox" id="ai-mode-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 left-0 transition-all duration-300" onclick="handleToggleClick()">
                <label for="ai-mode-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
            </div>
            <span class="text-xs font-bold text-emerald-600 dark:text-emerald-400" id="mode-label">Modo Offline</span>
        </div>

        <button onclick="toggleHistory()" class="text-slate-500 hover:text-kyro-light dark:hover:text-kyro-dark transition-colors p-2" title="Hist√≥rico"><i class="fa-solid fa-clock-rotate-left text-lg"></i></button>
        <button onclick="toggleConfigModal()" class="text-slate-500 hover:text-kyro-light dark:hover:text-kyro-dark transition-colors p-2 relative" title="Configurar API Key">
            <i class="fa-solid fa-gear text-lg"></i>
            <span id="config-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
        </button>
        <button onclick="toggleTheme()" class="text-slate-500 hover:text-yellow-600 transition-colors p-2">
            <i class="fa-solid fa-moon dark:hidden text-lg"></i>
            <i class="fa-solid fa-sun hidden dark:inline text-lg"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden relative">
    
    <!-- SIDEBAR HIST√ìRICO -->
    <div id="history-sidebar" class="absolute top-0 right-0 h-full w-80 bg-white dark:bg-slate-800 shadow-2xl border-l border-slate-200 dark:border-slate-700 z-40 transform translate-x-full transition-transform duration-300 flex flex-col no-print">
        <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
            <h3 class="font-bold text-slate-700 dark:text-white"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Hist√≥rico</h3>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>
        <div class="p-3 border-t border-slate-200 dark:border-slate-700">
            <button onclick="clearHistory()" class="w-full py-2 text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition">Limpar Hist√≥rico</button>
        </div>
    </div>

    <!-- MODAL CONFIGURA√á√ÉO -->
    <div id="config-modal" class="hidden absolute top-4 right-4 w-96 bg-white dark:bg-slate-800 shadow-2xl rounded-lg border border-slate-200 dark:border-slate-600 z-50 p-6 animate-fade-in no-print">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-robot text-kyro-light"></i> Configura√ß√£o Gemini</h3>
          <button onclick="toggleConfigModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
        </div>
        <p class="text-xs text-blue-600 dark:text-blue-400 mb-3 bg-blue-50 dark:bg-blue-900/20 p-2 rounded border border-blue-200 dark:border-blue-800">
            <i class="fa-solid fa-circle-info"></i> Chave necess√°ria para recursos de IA.
        </p>
        <div id="manual-input-area">
            <input type="password" id="api-key-input" class="w-full border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded p-2 text-sm mb-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="Cole sua API Key aqui...">
            <div class="flex gap-2 mb-3">
                <button onclick="testApiKey()" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 py-2 rounded text-xs font-medium transition">Testar</button>
                <button onclick="saveApiKey()" class="flex-1 bg-kyro-light hover:bg-blue-800 text-white font-medium py-2 rounded text-xs transition shadow-sm">Salvar</button>
            </div>
            <div id="test-result" class="hidden mb-3 p-2 rounded text-xs"></div>
            <button onclick="clearApiKey()" class="w-full text-red-500 text-xs hover:underline text-center">Remover Chave</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative overflow-hidden bg-slate-100 dark:bg-slate-900">
        
        <!-- VIEW 1: EXTRA√á√ÉO PDF (LAYOUT ORIGINAL) -->
        <div id="view-extraction" class="absolute inset-0 overflow-y-auto p-4 md:p-8 animate-fade-in custom-scrollbar">
            <div class="max-w-[95%] mx-auto space-y-6">
                
                <!-- Upload Box -->
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-8 transition-colors">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                        Carregar Extrato (PDF)
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-6 ml-10">O sistema extrair√° os dados conforme o layout original (Tabela Completa).</p>
                    
                    <div id="drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-10 text-center cursor-pointer hover:border-kyro-light hover:bg-blue-50 dark:hover:bg-slate-700 transition duration-300">
                        <input type="file" id="file-input" class="hidden" accept=".pdf">
                        <i class="fas fa-file-pdf text-4xl text-slate-400 mb-4"></i>
                        <p class="text-lg font-medium text-slate-700 dark:text-slate-200">Clique ou arraste o <span class="text-kyro-light dark:text-blue-400">PDF aqui</span></p>
                    </div>

                    <!-- File Info & Process Button -->
                    <div id="file-info" class="hidden mt-4 bg-blue-50 dark:bg-slate-700 p-4 rounded-lg flex items-center justify-between border border-blue-100 dark:border-slate-600">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            <span id="file-name" class="font-medium text-blue-800 dark:text-blue-200">arquivo.pdf</span>
                        </div>
                        <div class="flex gap-2">
                             <button id="remove-file" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                             <button id="btn-process" class="bg-kyro-light text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition flex items-center gap-2">
                                <i class="fas fa-cogs"></i> Transformar e Extrair
                             </button>
                        </div>
                    </div>

                    <!-- Loader -->
                    <div id="loader" class="hidden flex flex-col items-center justify-center py-6 mt-4">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-kyro-light mb-2"></div>
                        <p class="text-slate-600 dark:text-slate-400 text-sm animate-pulse">Lendo PDF e Gerando TXT...</p>
                        <p id="step-text" class="text-xs text-slate-400 mt-1">Passo 1/3: Interpretando layout...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="hidden space-y-6">
                    
                    <!-- Quick Action: Send to Editor -->
                    <div class="bg-gradient-to-r from-emerald-500 to-emerald-700 rounded-xl shadow-lg p-6 text-white flex justify-between items-center transform transition hover:scale-[1.01]">
                        <div>
                            <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-wand-magic-sparkles"></i> Extra√ß√£o Conclu√≠da!</h3>
                            <p class="text-emerald-100 text-sm mt-1">Total Calculado: <span id="total-sum-banner" class="font-mono font-bold text-white text-lg ml-1">R$ 0,00</span></p>
                        </div>
                        <button onclick="sendToEditor()" class="bg-white text-emerald-700 px-6 py-3 rounded-lg font-bold shadow hover:bg-emerald-50 transition flex items-center gap-2 animate-pulse">
                            <i class="fas fa-pen-nib"></i> Redigir Despacho
                        </button>
                    </div>

                    <!-- TXT Preview (Original Feature Restored) -->
                    <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-white font-bold flex items-center gap-2 text-sm">
                                <i class="fas fa-file-alt text-green-400"></i> 
                                2. Arquivo Intermedi√°rio Gerado (relatorio.txt)
                            </h3>
                            <div class="flex space-x-3">
                                <button onclick="copyTxt()" class="text-xs bg-slate-700 text-white px-3 py-1.5 rounded hover:bg-slate-600 border border-slate-600">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                                <button onclick="downloadTxt()" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 font-bold shadow">
                                    <i class="fas fa-download"></i> Baixar .txt
                                </button>
                            </div>
                        </div>
                        <div class="txt-preview custom-scrollbar" id="txt-content"></div>
                    </div>

                    <!-- Table (Full Columns Restored) -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6 overflow-hidden">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                            <i class="fas fa-table text-kyro-light"></i> 3. Dados Extra√≠dos (Tabela Completa)
                        </h3>
                        <div id="table-container" class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-700 kyro-table">
                            <!-- JS Injected Table -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: EDITOR JUR√çDICO -->
        <div id="view-editor" class="absolute inset-0 hidden flex flex-col md:flex-row bg-white dark:bg-slate-900">
            
            <!-- LEFT: INPUT -->
            <section class="flex-1 flex flex-col border-r border-slate-200 dark:border-slate-700 min-w-0">
                <div class="p-3 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h3 class="font-semibold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                        <i class="fa-regular fa-pen-to-square text-kyro-light dark:text-blue-400"></i> Contexto / Entrada
                    </h3>
                    <select onchange="insertTemplate(this.value); this.value=''" class="text-xs border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300">
                        <option value="">üìã Modelos...</option>
                        <option value="deferimento">Deferimento</option>
                        <option value="citacao">Cita√ß√£o Edital</option>
                        <option value="prescricao">Prescri√ß√£o</option>
                    </select>
                </div>
                
                <div class="flex-1 relative bg-white dark:bg-slate-900">
                    <textarea id="input-text" spellcheck="true"
                    class="w-full h-full p-6 resize-none focus:outline-none focus:bg-blue-50/20 dark:focus:bg-blue-900/10 transition-colors font-mono text-sm leading-relaxed text-slate-700 dark:text-slate-300 bg-transparent placeholder-slate-400 dark:placeholder-slate-600"
                    placeholder="Cole aqui o texto ou extraia do PDF..." oninput="updateCounters()"></textarea>
                    <div class="absolute bottom-2 right-4 text-[10px] text-slate-400 bg-white/80 dark:bg-slate-800/80 px-2 rounded backdrop-blur-sm pointer-events-none">
                        <span id="input-counter">0 palavras</span>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="p-3 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 shadow-md z-10">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                        <button onclick="routeProcess('correcao')" class="action-btn border-slate-200 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 group">
                            <i class="fa-solid fa-spell-check text-blue-600 dark:text-blue-400 mb-1"></i>
                            <span class="text-[10px] uppercase font-bold">Corre√ß√£o</span>
                        </button>
                        <button onclick="routeProcess('rebuscado')" class="action-btn border-slate-200 dark:border-slate-600 hover:bg-amber-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 group">
                            <i class="fa-solid fa-scroll text-amber-600 dark:text-amber-500 mb-1"></i>
                            <span class="text-[10px] uppercase font-bold">Erudito</span>
                        </button>
                        <button onclick="routeProcess('simplificar')" class="action-btn border-slate-200 dark:border-slate-600 hover:bg-cyan-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 group">
                            <i class="fa-solid fa-language text-cyan-600 dark:text-cyan-500 mb-1"></i>
                            <span class="text-[10px] uppercase font-bold">Simplificar</span>
                        </button>
                        <button onclick="routeProcess('tecnico')" class="action-btn border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 hover:bg-emerald-100 dark:hover:bg-slate-700 text-emerald-800 dark:text-emerald-400 col-span-2 md:col-span-2 shadow-sm">
                            <i class="fa-solid fa-gavel text-lg mb-1"></i>
                            <span class="text-xs uppercase font-extrabold">Gerar Despacho</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- RIGHT: OUTPUT -->
            <section class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-slate-900/50">
                <div class="p-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center shadow-sm">
                    <h3 class="font-semibold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-file-signature text-amber-600 dark:text-amber-500"></i> Resultado
                        <span id="badge-mode" class="text-[10px] bg-gray-200 text-gray-600 px-2 rounded-full ml-2">Aguardando</span>
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="exportToWord()" class="text-xs flex items-center gap-1 text-blue-700 border border-blue-200 bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition"><i class="fa-solid fa-file-word"></i> Word</button>
                        <button onclick="copyToClipboard()" class="text-xs flex items-center gap-1 text-slate-600 border border-slate-200 px-3 py-1 rounded hover:bg-slate-50 transition"><i class="fa-regular fa-copy"></i> Copiar</button>
                    </div>
                </div>

                <div class="flex-1 p-8 overflow-y-auto custom-scrollbar relative" id="output-container">
                    
                    <!-- Printable Hidden -->
                    <div id="printable-area" class="hidden">
                        <div class="border-b-2 border-black mb-6 pb-2 text-center">
                            <h1 class="text-xl font-bold font-serif uppercase">Prefeitura Municipal de Limeira</h1>
                            <h2 class="text-sm font-sans uppercase">Secretaria de Assuntos Jur√≠dicos</h2>
                        </div>
                        <div id="print-content" class="text-justify font-serif text-lg leading-relaxed"></div>
                    </div>

                    <!-- States -->
                    <div id="placeholder-state" class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 opacity-60">
                        <i class="fa-solid fa-scale-balanced text-5xl mb-4 text-slate-200 dark:text-slate-700"></i>
                        <p class="text-sm font-medium">Extraia dados ou digite para iniciar.</p>
                    </div>
                    <div id="loader-state" class="hidden h-full flex flex-col items-center justify-center">
                        <div class="w-10 h-10 border-4 border-blue-200 border-t-kyro-light rounded-full animate-spin mb-4"></div>
                        <p class="text-sm text-slate-600 animate-pulse" id="loader-msg">Processando...</p>
                    </div>
                    <div id="content-state" class="hidden h-full flex flex-col">
                        <div id="output-text" class="prose prose-slate dark:prose-invert max-w-none text-slate-800 dark:text-slate-200 leading-relaxed text-justify whitespace-pre-wrap font-serif text-lg flex-1 outline-none focus:ring-0" contenteditable="true"></div>
                    </div>
                </div>
            </section>
        </div>

    </main>
  </div>

  <style>
      .action-btn { @apply flex flex-col items-center justify-center p-2 rounded border transition active:scale-95; }
  </style>

  <script>
    // --- STATE & GLOBAL VARIABLES ---
    let userApiKey = "";
    let useAI = false;
    let history = JSON.parse(localStorage.getItem('kyro_history') || '[]');
    let extractedDataCache = null; // Store data from PDF
    let currentFile = null;
    let generatedTxt = "";

    // --- INITIALIZATION ---
    window.onload = () => {
        const savedKey = localStorage.getItem('kyro_gemini_api_key');
        const checkbox = document.getElementById('ai-mode-toggle');
        
        if(savedKey) {
            userApiKey = savedKey;
            document.getElementById('api-key-input').value = savedKey;
            checkbox.checked = true;
            useAI = true;
            updateModeUI(true);
        } else {
            document.getElementById('config-badge').classList.remove('hidden');
        }
        
        if (localStorage.getItem('kyro_theme') === 'dark') document.documentElement.classList.add('dark');
        renderHistory();
    }

    // --- TAB NAVIGATION ---
    function switchTab(tabId) {
        document.getElementById('view-extraction').classList.add('hidden');
        document.getElementById('view-editor').classList.add('hidden');
        
        document.getElementById('tab-extraction').className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200";
        document.getElementById('tab-editor').className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200";

        if(tabId === 'extraction') {
            document.getElementById('view-extraction').classList.remove('hidden');
            document.getElementById('tab-extraction').className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all shadow bg-white dark:bg-slate-600 text-slate-800 dark:text-white";
        } else {
            document.getElementById('view-editor').classList.remove('hidden');
            document.getElementById('view-editor').classList.add('flex');
            document.getElementById('tab-editor').className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all shadow bg-white dark:bg-slate-600 text-slate-800 dark:text-white";
        }
    }

    // --- PDF EXTRACTION LOGIC (EXATAMENTE DO SITE ORIGINAL) ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const stepText = document.getElementById('step-text');
    const txtContentDisplay = document.getElementById('txt-content');
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-kyro-light'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-kyro-light'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-kyro-light'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });
    document.getElementById('remove-file').addEventListener('click', resetExtraction);
    document.getElementById('btn-process').addEventListener('click', processPipeline);

    function handleFile(file) {
        if (file.type !== 'application/pdf') { showToast('Apenas arquivos PDF s√£o aceitos.', 'error'); return; }
        currentFile = file;
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('drop-zone').classList.add('hidden');
        document.getElementById('file-info').classList.remove('hidden');
        document.getElementById('results-container').classList.add('hidden');
    }

    function resetExtraction() {
        currentFile = null;
        fileInput.value = '';
        generatedTxt = "";
        document.getElementById('file-info').classList.add('hidden');
        document.getElementById('drop-zone').classList.remove('hidden');
        document.getElementById('results-container').classList.add('hidden');
    }

    // PIPELINE COMPLETO (RESTAURADO)
    async function processPipeline() {
        if (!currentFile) return;
        const loader = document.getElementById('loader');
        loader.classList.remove('hidden');
        document.getElementById('btn-process').disabled = true;

        try {
            // ETAPA 1: Ler PDF Bruto
            updateStep("Lendo arquivo PDF bruto...");
            const rawPdfText = await extractTextFromPDF(currentFile);

            // ETAPA 2: Transformar PDF em Dados Estruturados (Parser Original)
            updateStep("Interpretando layout e unindo linhas...");
            await new Promise(r => setTimeout(r, 800)); 
            const structuredData = parseRawPdfToData(rawPdfText);
            
            // ETAPA 3: Gerar TXT
            updateStep("Gerando TXT Intermedi√°rio...");
            generatedTxt = convertDataToTxt(structuredData);
            
            // ETAPA 4: Extrair Dados do TXT (Para garantir fidelidade ao original)
            updateStep("Processando tabela final...");
            const finalData = parseTxtToData(generatedTxt);
            
            extractedDataCache = finalData; // Save for AI integration

            renderTxtPreview(generatedTxt);
            renderTable(finalData);
            
            loader.classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');

        } catch (error) {
            console.error(error);
            showToast("Erro ao processar PDF.", "error");
            loader.classList.add('hidden');
        }
        document.getElementById('btn-process').disabled = false;
    }

    function updateStep(msg) {
        stepText.textContent = msg;
    }

    // 1. Extra√ß√£o PDF.js
    async function extractTextFromPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            fullText += textContent.items.map(item => item.str + (item.hasEOL ? '\n' : ' ')).join('');
        }
        return fullText;
    }

    // 2. Parser Inteligente (Com Corre√ß√£o de Quebra de Linha + Corre√ß√£o IC/Processos)
    function parseRawPdfToData(text) {
        const cleanText = text.replace(/\r\n/g, '\n');
        const lines = cleanText.split('\n');
        const debts = [];
        
        let pendingBuffer = ""; 

        // Regex de detec√ß√£o de dados: aceita YYYY ou MM/YYYY ou DD/MM/YYYY
        const regexDate = /\b(19|20)\d{2}(?:\/\d{1,2})?\b|\b\d{2}\/\d{2}\/\d{4}\b/;
        const regexMoney = /(?:R\$\s*)?[\d.]*\d+,\d{2}\b/;
        
        // Regex de LIXO/Header que deve limpar o buffer e ser ignorado
        const regexHeader = /(NATUREZA|ORIGEM|PRINCIPAL|CORRE√á√ÉO|JUROS|MULTA|TOTAL|VENCIMENTO|P√ÅGINA|EMISS√ÉO|SALDO|ATUALIZADO|SIT\.\s*LANC|SIT\.\s*D√çVIDA|N¬∫\s*PROCESSO|CDA|NEGO\.)/i;

        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) return;

            const isDataLine = regexDate.test(trimmedLine) && regexMoney.test(trimmedLine);
            const isHeaderOrFooter = regexHeader.test(trimmedLine);

            if (isDataLine) {
                if (/SALDO ATUALIZADO|TOTAL/i.test(trimmedLine)) {
                    pendingBuffer = "";
                    return; // Pula linha de resumo
                }

                const fullLine = (pendingBuffer + " " + trimmedLine).trim();
                pendingBuffer = ""; 

                // --- L√ìGICA DE EXTRA√á√ÉO REVISADA ---
                
                let normalizedLine = fullLine.replace(/(\d)\s+([.,])\s+(\d)/g, '$1$2$3')
                                             .replace(/(\d)\s+([.,])(\d)/g, '$1$2$3');

                // 1. Extrair e remover valores monet√°rios primeiro
                const moneyMatches = normalizedLine.match(/(?:R\$\s*)?[\d.]*\d+,\d{2}\b/gi) || [];
                const moneyValues = moneyMatches.map(v => v.replace(/R\$\s*/gi, '').trim());
                
                // Limpeza b√°sica da linha (sem valores monet√°rios)
                let processingLine = normalizedLine;
                moneyMatches.forEach(m => processingLine = processingLine.replace(m, ''));
                processingLine = processingLine.replace(/"\s*,\s*"/g, ' ').replace(/["']/g, '').replace(/\s+/g, ' ').trim();

                // 2. Extrair Vencimento (DD/MM/AAAA)
                const dateMatch = processingLine.match(/\b\d{2}\/\d{2}\/\d{4}\b/);
                const vencimento = dateMatch ? dateMatch[0] : '';
                if (vencimento) processingLine = processingLine.replace(vencimento, '').trim();

                // 3. Tokenizar para processamento posicional
                let tokens = processingLine.split(/\s+/).filter(t => t);

                // 4. Encontrar Situa√ß√£o (Divisor de √°guas entre Origem e Processos)
                const keywords = ['NORMAL', 'COMPLEMENTAR', 'OFICIO', 'AI', 'PARCELADO', 'ABERTO', 'SUSPENSO', 'AJUIZADA', 'CANCELADA', 'PAGO', 'ATIVO', 'INSCRITA', 'CORRENTE'];
                
                let sitLanc = 'ABERTO';
                let sitDiv = 'CORRENTE';
                let splitIndex = tokens.length; // Default: tudo √© esquerda se n√£o achar situa√ß√£o

                // Procura keywords da direita para esquerda para achar o ponto de corte
                for (let i = tokens.length - 1; i >= 0; i--) {
                    const tokenUpper = tokens[i].toUpperCase();
                    if (keywords.includes(tokenUpper)) {
                         // Achamos uma keyword de situa√ß√£o. Este √© o divisor.
                         splitIndex = i; // Tudo antes disso √© Origem
                         // Ajusta Situa√ß√£o
                         if (['AJUIZADA', 'INSCRITA', 'CORRENTE', 'ATIVO', 'CANCELADA', 'PAGO'].includes(tokenUpper)) sitDiv = tokenUpper;
                         if (['NORMAL', 'COMPLEMENTAR', 'OFICIO', 'AI', 'PARCELADO', 'SUSPENSO', 'ABERTO'].includes(tokenUpper)) {
                             sitLanc = (tokenUpper === 'NORMAL') ? 'ABERTO' : tokenUpper;
                         }
                    }
                }

                // Divide tokens em Parte Esquerda (Dados) e Parte Direita (Processos)
                const leftTokens = tokens.slice(0, splitIndex).filter(t => !keywords.includes(t.toUpperCase()));
                const rightTokens = tokens.slice(splitIndex).filter(t => !keywords.includes(t.toUpperCase()));

                // --- PROCESSAMENTO DA ESQUERDA (Origem, Nego, Comp, ID, IC) ---
                
                let id = '', nat = '', orig = '', nego = '', icRed = '', ic = '', competencia = '';

                if (leftTokens.length > 0) {
                    // A. ID (Primeiro token num√©rico)
                    if (/^[\d.]+$/.test(leftTokens[0])) {
                        id = leftTokens.shift();
                    }

                    // B. Natureza (IMOB, OUTRAS...)
                    const natIndex = leftTokens.findIndex(t => ['MOBIL', 'IMOBIL', 'IMOB', 'OUTRAS'].includes(t.toUpperCase()));
                    if (natIndex !== -1) {
                        nat = leftTokens[natIndex];
                        leftTokens.splice(natIndex, 1);
                    }

                    // C. Compet√™ncia (Busca Reverso)
                    let compIndex = -1;
                    for (let i = leftTokens.length - 1; i >= 0; i--) {
                        const t = leftTokens[i];
                        // Match MM/YYYY
                        if (/^(0[1-9]|1[0-2])\/\d{4}$/.test(t)) {
                            competencia = t;
                            compIndex = i;
                            break; 
                        }
                        // Match YYYY
                        if (/^(19|20)\d{2}$/.test(t) && !competencia) {
                            competencia = t;
                            compIndex = i;
                            break;
                        }
                    }
                    if (compIndex !== -1) leftTokens.splice(compIndex, 1);

                    // D. Negocia√ß√£o (Busca por N.../AAAA)
                    const negoIndex = leftTokens.findIndex(t => /^\d+\/(19|20)\d{2}$/.test(t));
                    if (negoIndex !== -1) {
                        nego = leftTokens[negoIndex];
                        leftTokens.splice(negoIndex, 1);
                    }

                    // E. IC / IC Red (N√∫meros no final da esquerda)
                    // L√≥gica de sufixo para pegar qualquer n√∫mero no final dos dados como IC/ICRed.
                    const isNumeric = (t) => /^[\d.-]+$/.test(t);
                    let numericSuffix = [];
                    
                    // Consome n√∫meros estritamente do final da lista para o in√≠cio
                    while (leftTokens.length > 0 && isNumeric(leftTokens[leftTokens.length - 1])) {
                        numericSuffix.unshift(leftTokens.pop());
                    }

                    if (numericSuffix.length >= 2) {
                        // Se tiver 2 ou mais, os dois √∫ltimos s√£o IC e IC Red
                        ic = numericSuffix.pop();
                        icRed = numericSuffix.pop();
                        
                        // Se houver "excesso" de n√∫meros (ex: parte da origem era n√∫mero), devolve para leftTokens
                        while(numericSuffix.length > 0) {
                            leftTokens.push(numericSuffix.shift());
                        }
                    } else if (numericSuffix.length === 1) {
                        const token = numericSuffix[0];
                        // Heur√≠stica simples: IC Reduzido costuma ser inteiro curto, IC costuma ser longo ou formatado
                        if (token.length > 8 || token.includes('.') || token.includes('-')) {
                            ic = token; 
                        } else {
                            icRed = token;
                        }
                    }

                    // F. Origem (O que sobrou de texto)
                    orig = leftTokens.join(' ');
                }

                // --- PROCESSAMENTO DA DIREITA (Processos e CDA) ---
                let cda = '', procDa = '', procForum = '';
                
                const validRightTokens = rightTokens.filter(t => t.replace(/\D/g,'').length >= 3);

                // 1. Identificar F√≥rum (Prioridade M√°xima por sufixo espec√≠fico ou padr√£o CNJ)
                const specificForumIdx = validRightTokens.findIndex(t => t.replace(/[\-\.]/g, '').endsWith('8260320'));
                if (specificForumIdx !== -1) {
                    procForum = validRightTokens[specificForumIdx];
                    validRightTokens.splice(specificForumIdx, 1);
                } 
                else if (sitDiv === 'AJUIZADA') {
                    const cnjIdx = validRightTokens.findIndex(t => /\d{7}-\d{2}/.test(t));
                    if (cnjIdx !== -1) {
                        procForum = validRightTokens[cnjIdx];
                        validRightTokens.splice(cnjIdx, 1);
                    }
                }

                // 2. Identificar Processo DA (Formato Espec√≠fico: 2021.083.2154.010.00855769)
                // Regex busca padr√£o: 4dig.3dig.4dig.3dig.Digitos
                const procDaIdx = validRightTokens.findIndex(t => /^\d{4}\.\d{3,}\.\d{3,}\.\d{3,}\.\d+/.test(t));
                if (procDaIdx !== -1) {
                    procDa = validRightTokens[procDaIdx];
                    validRightTokens.splice(procDaIdx, 1);
                }

                // 3. Atribui√ß√£o de CDA e Res√≠duos
                if (validRightTokens.length > 0) cda = validRightTokens.pop();
                
                // Se n√£o achou procDA pelo regex espec√≠fico, pega o pr√≥ximo dispon√≠vel
                if (!procDa && validRightTokens.length > 0) procDa = validRightTokens.pop();
                
                // Se n√£o achou procForum e sobrou algo
                if (!procForum && validRightTokens.length > 0) procForum = validRightTokens.pop();

                // --- MONTAGEM DOS VALORES ---
                const v = (i) => moneyValues[i] || '0,00';
                let vals = {};
                if (moneyValues.length >= 11) {
                    vals = { ref: v(0), princ: v(1), desc: v(2), pago: v(3), saldo: v(4), multa: v(5), juros: v(6), corr: v(7), hon: v(8), dilig: v(9), total: v(10) };
                } else {
                    vals.total = moneyValues[moneyValues.length - 1];
                    vals.princ = moneyValues[0];
                    if (moneyValues.length >= 4) vals.juros = moneyValues[moneyValues.length - 2];
                    if (moneyValues.length >= 5) vals.multa = moneyValues[moneyValues.length - 3];
                }

                debts.push({
                    id, nat, orig, nego, icRed, ic, comp: competencia, venc: vencimento,
                    vPrincRef: vals.ref || '0,00', vPrinc: vals.princ || '0,00', vDesc: vals.desc || '0,00',
                    vPago: vals.pago || '0,00', vSaldoP: vals.saldo || '0,00', vMulta: vals.multa || '0,00',
                    vJuros: vals.juros || '0,00', vCorr: vals.corr || '0,00', vHon: vals.hon || '0,00',
                    vDilig: vals.dilig || '0,00', vTotal: vals.total || '0,00',
                    sitLanc, sitDiv, procForum, procDa, cda
                });
            } else {
                if (isHeaderOrFooter) {
                    pendingBuffer = "";
                } else {
                    pendingBuffer += " " + trimmedLine;
                }
            }
        });
        return debts;
    }

    // 3. Serializador
    function convertDataToTxt(data) {
        const header = "# | NATUREZA | ORIGEM | N¬∫ NEGO | I.C. REDUZIDO | I.C. | COMP. | VENC. | PRINCIPAL REF. | PRINCIPAL | DESC./ABATI. | PRINCIPAL (PAGO) | PRINCIPAL (SALDO) | MULTA | JUROS | CORRE√á√ÉO | HONOR√ÅRIOS | DILIG√äNCIAS | SALDO (ATUALIZADO) | SIT. LANC. | SIT. D√çVIDA | N¬∫ PROCESSO F√ìRUM | N¬∫ PROCESSO DA | CDA";
        const rows = data.map(d => {
            return [
                d.id, d.nat, d.orig, d.nego, d.icRed, d.ic, d.comp, d.venc,
                d.vPrincRef, d.vPrinc, d.vDesc, d.vPago, d.vSaldoP, d.vMulta, d.vJuros, d.vCorr, d.vHon, d.vDilig, d.vTotal,
                d.sitLanc, d.sitDiv, d.procForum, d.procDa, d.cda
            ].join(' | ');
        });
        return header + "\n" + rows.join('\n');
    }

    // 4. Parser do TXT
    function parseTxtToData(txtContent) {
        const lines = txtContent.split('\n');
        const data = [];
        for(let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if(!line) continue;
            const cols = line.split('|').map(c => c.trim());
            if(cols.length < 5) continue;
            
            data.push({
                id: cols[0], nat: cols[1], orig: cols[2], nego: cols[3], icRed: cols[4], ic: cols[5],
                comp: cols[6], venc: cols[7],
                vPrincRef: cols[8], vPrinc: cols[9], vDesc: cols[10], vPago: cols[11], vSaldoP: cols[12],
                vMulta: cols[13], vJuros: cols[14], vCorr: cols[15], vHon: cols[16], vDilig: cols[17], vTotal: cols[18],
                sitLanc: cols[19], sitDiv: cols[20], procForum: cols[21], procDa: cols[22], cda: cols[23]
            });
        }
        return data;
    }

    // --- RENDER TABLE & TXT PREVIEW ---
    function renderTxtPreview(text) {
        txtContentDisplay.textContent = text;
    }

    function downloadTxt() {
        const blob = new Blob([generatedTxt], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'relatorio.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function copyTxt() {
        navigator.clipboard.writeText(generatedTxt).then(() => showToast("Texto copiado!", "success"));
    }

    function renderTable(data) {
        const container = document.getElementById('table-container');
        if (data.length === 0) { container.innerHTML = '<div class="p-4 text-center text-gray-500">Nenhum dado encontrado no TXT gerado.</div>'; return; }

        let total = 0;
        const rowsHtml = data.map(d => {
            const val = parseFloat(d.vTotal.replace('.', '').replace(',', '.'));
            if(!isNaN(val)) total += val;

            return `
            <tr class="text-[10px] hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors">
                <td class="font-mono bg-gray-50 dark:bg-slate-700">${d.id}</td>
                <td>${d.nat}</td>
                <td class="max-w-[150px] truncate font-bold text-slate-700 dark:text-slate-300" title="${d.orig}">${d.orig}</td>
                <td class="col-center font-mono text-xs text-purple-700 dark:text-purple-400 font-bold">${d.nego}</td>
                <td class="col-center font-mono text-blue-700 dark:text-blue-400 font-bold">${d.icRed}</td>
                <td class="col-center font-mono">${d.ic}</td>
                <td class="col-center font-bold bg-yellow-50 dark:bg-yellow-900/20">${d.comp}</td>
                <td class="col-center">${d.venc}</td>
                <td class="col-money text-gray-400">${d.vPrincRef}</td>
                <td class="col-money font-bold">${d.vPrinc}</td>
                <td class="col-money text-gray-400">${d.vDesc}</td>
                <td class="col-money text-gray-400">${d.vPago}</td>
                <td class="col-money text-gray-400">${d.vSaldoP}</td>
                <td class="col-money">${d.vMulta}</td>
                <td class="col-money">${d.vJuros}</td>
                <td class="col-money">${d.vCorr}</td>
                <td class="col-money">${d.vHon}</td>
                <td class="col-money">${d.vDilig}</td>
                <td class="col-money bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 font-bold border-l-2 border-green-200">${d.vTotal}</td>
                <td class="col-center text-[9px]">${d.sitLanc}</td>
                <td class="col-center font-semibold ${d.sitDiv === 'AJUIZADA' ? 'text-red-600 dark:text-red-400' : 'text-blue-600 dark:text-blue-400'}">${d.sitDiv}</td>
                <td class="col-center font-mono text-[9px] max-w-[100px] truncate" title="${d.procForum}">${d.procForum}</td>
                <td class="col-center font-mono text-[9px] max-w-[80px] truncate" title="${d.procDa}">${d.procDa}</td>
                <td class="col-center font-mono text-[9px] font-bold text-slate-700 dark:text-slate-300">${d.cda}</td>
            </tr>
        `}).join('');

        const headerHtml = `
            <table class="w-full text-left border-collapse min-w-[2000px]">
                <thead>
                    <tr>
                        <th class="sticky left-0 z-20 bg-gray-100 dark:bg-slate-700">#</th><th>Nat.</th><th>Origem</th>
                        <th>N¬∫ Nego</th>
                        <th>I.C Red</th><th>I.C</th><th>Comp.</th>
                        <th>Venc.</th><th class="text-right">Prin. Ref</th><th class="text-right">Principal</th>
                        <th class="text-right">Desc/Abat</th><th class="text-right">Pago</th><th class="text-right">Saldo</th>
                        <th class="text-right">Multa</th><th class="text-right">Juros</th><th class="text-right">Corr.</th>
                        <th class="text-right">Honor.</th><th class="text-right">Dilig.</th><th class="text-right bg-green-50 dark:bg-green-900/20">Total</th>
                        <th class="text-center">Sit. Lanc</th><th class="text-center">Sit. Div</th>
                        <th class="text-center">F√≥rum</th>
                        <th class="text-center">Pro. DA</th><th class="text-center">CDA</th>
                    </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
            </table>
        `;

        container.innerHTML = headerHtml;
        const totalFmt = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.getElementById('total-sum-banner').innerText = totalFmt;
    }

    // --- INTEGRATION: SEND TO EDITOR ---
    function sendToEditor() {
        if (!extractedDataCache || extractedDataCache.length === 0) { showToast("Sem dados para enviar.", "warning"); return; }
        
        let total = 0;
        const procs = new Set();
        const cdas = new Set();
        const dates = new Set();
        const origins = new Set();

        extractedDataCache.forEach(d => {
            const v = parseFloat(d.vTotal.replace('.','').replace(',','.'));
            if(!isNaN(v)) total += v;
            if(d.procForum) procs.add(d.procForum);
            if(d.cda) cdas.add(d.cda);
            if(d.venc) dates.add(d.venc);
            if(d.orig) origins.add(d.orig);
        });

        const summary = `DADOS EXTRA√çDOS DO PDF:
- Origem da D√≠vida: ${Array.from(origins).join(', ')}
- Valor Total Atualizado: ${total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
- CDA(s): ${Array.from(cdas).join(', ') || 'N√£o consta'}
- Processo(s) Judicial(is): ${Array.from(procs).join(', ') || 'N√£o consta'}
- Per√≠odo/Vencimentos: ${Array.from(dates).slice(0, 3).join(', ')}...

SOLICITA√á√ÉO:
Elaborar minuta referente a estes d√©bitos.`;

        document.getElementById('input-text').value = summary;
        updateCounters();
        switchTab('editor');
        showToast("Dados transferidos para o Editor!", "success");
    }

    // --- EDITOR AI LOGIC (From Texto_IA) ---
    function routeProcess(type) {
        const text = document.getElementById("input-text").value.trim();
        if (!text) { showToast("Entrada vazia.", "warning"); return; }

        if (useAI) {
            if(!userApiKey) { showToast("Modo IA requer Chave API.", "error"); toggleConfigModal(); return; }
            processWithAI(type, text);
        } else {
            processOffline(type, text);
        }
    }

    async function processWithAI(type, text) {
        setOutputState('loading', 'Consultando Gemini...');
        updateBadge('IA (Gemini)');

        const baseContext = "Voc√™ √© um Assistente Jur√≠dico Oficial na Prefeitura de Limeira.";
        let prompt = "";
        switch (type) {
            case 'correcao': prompt = `${baseContext} Corrija formalmente: "${text}"`; break;
            case 'rebuscado': prompt = `${baseContext} Reescreva com tom jur√≠dico erudito: "${text}"`; break;
            case 'simplificar': prompt = `${baseContext} Use Linguagem Simples (Legal Design) para explicar: "${text}"`; break;
            case 'tecnico': prompt = `${baseContext} Escreva um DESPACHO OFICIAL COMPLETO E FUNDAMENTADO com base nestes dados: "${text}". Use formata√ß√£o padr√£o de processo.`; break;
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na resposta da IA.";
            renderOutput(resultText);
            addToHistory(type, text, resultText);
        } catch (error) {
            showToast("Erro na IA: " + error.message, "error");
            setOutputState('empty');
        }
    }

    function processOffline(type, text) {
        setOutputState('loading', 'Processando Localmente...');
        setTimeout(() => {
            let res = "";
            if (type === 'tecnico') res = `DESPACHO (OFFLINE)\n\nTrata-se de an√°lise de d√©bitos.\n\nCONSIDERANDO os dados apresentados: \n${text}\n\nENCAMINHE-SE para prosseguimento.\n\nLimeira, ${new Date().toLocaleDateString()}.`;
            else if (type === 'simplificar') res = "RESUMO SIMPLES (OFFLINE):\nO texto trata de d√≠vidas com a prefeitura que precisam ser regularizadas.";
            else res = text + "\n\n(Funcionalidade limitada no modo offline.)";
            
            renderOutput(res);
            addToHistory(type + ' (Off)', text, res);
        }, 500);
    }

    // --- UI HELPERS ---
    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const color = type==='success'?'bg-emerald-600':type==='error'?'bg-red-600':'bg-slate-800';
        toast.className = `${color} text-white px-4 py-3 rounded shadow-lg text-sm animate-slide-in`;
        toast.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${msg}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function renderOutput(text) {
        document.getElementById('output-text').innerText = text;
        document.getElementById('print-content').innerHTML = text.replace(/\n/g, '<br>');
        setOutputState('content');
    }
    
    function setOutputState(st, msg="") {
        ['placeholder-state','loader-state','content-state'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        if(st==='loading') { document.getElementById('loader-state').classList.remove('hidden'); document.getElementById('loader-msg').innerText=msg; }
        else if(st==='content') document.getElementById('content-state').classList.remove('hidden');
        else document.getElementById('placeholder-state').classList.remove('hidden');
    }

    function updateBadge(txt) { document.getElementById('badge-mode').innerText = txt; }
    function insertTemplate(v) { if(v) document.getElementById('input-text').value += v==="deferimento"?"Defiro o pedido...":v==="citacao"?"Certifico que...":"Prescrito conforme..."; }
    function updateCounters() { document.getElementById('input-counter').innerText = document.getElementById('input-text').value.split(/\s+/).filter(w=>w).length + ' palavras'; }

    // --- CONFIG & TOGGLES ---
    function handleToggleClick() {
        if(document.getElementById('ai-mode-toggle').checked) {
            if(!userApiKey) { 
                document.getElementById('ai-mode-toggle').checked=false; 
                toggleConfigModal(); 
                showToast("Configure a API Key primeiro.", "warning"); 
            } else { useAI=true; updateModeUI(true); }
        } else { useAI=false; updateModeUI(false); }
    }
    function updateModeUI(isAI) {
        const l = document.getElementById('mode-label');
        l.innerText = isAI ? "IA (Gemini)" : "Modo Offline";
        l.className = isAI ? "text-xs font-bold text-blue-600 dark:text-blue-400" : "text-xs font-bold text-emerald-600 dark:text-emerald-400";
    }
    function toggleConfigModal() { document.getElementById('config-modal').classList.toggle('hidden'); }
    function saveApiKey() { 
        const k = document.getElementById('api-key-input').value.trim();
        if(k.length>10) { localStorage.setItem('kyro_gemini_api_key', k); userApiKey=k; toggleConfigModal(); showToast("Salvo!", "success"); handleToggleClick(); }
    }
    function clearApiKey() { localStorage.removeItem('kyro_gemini_api_key'); userApiKey=""; document.getElementById('api-key-input').value=""; toggleConfigModal(); handleToggleClick(); }
    function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('kyro_theme', document.documentElement.classList.contains('dark')?'dark':'light'); }
    
    // History Stub
    function toggleHistory() { document.getElementById('history-sidebar').classList.toggle('translate-x-full'); }
    function addToHistory(type, input, output) { history.unshift({id:Date.now(), type, date:new Date().toLocaleTimeString(), input: input.substring(0,20)+'...', output}); localStorage.setItem('kyro_history', JSON.stringify(history)); renderHistory(); }
    function renderHistory() { 
        const list = document.getElementById('history-list'); 
        list.innerHTML = history.map(h => `<div onclick="document.getElementById('output-text').innerText=\`${h.output.replace(/`/g, '\\`')}\`; setOutputState('content');" class="p-2 border-b cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700"><div class="font-bold text-xs text-slate-500">${h.type} - ${h.date}</div><div class="text-xs truncate dark:text-slate-300">${h.input}</div></div>`).join(''); 
    }
    function clearHistory() { history=[]; localStorage.removeItem('kyro_history'); renderHistory(); }
    function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('output-text').innerText); showToast("Copiado!", "success"); }
    function exportToWord() { showToast("Exportando...", "info"); }
    function testApiKey() { showToast("Teste de API simulado. Salve para confirmar.", "info"); }
  </script>
</body>
</html>